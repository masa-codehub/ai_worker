# Gemini CLIとModel Context Protocol (MCP)：カスタムツール開発からセキュアな運用まで

---

## 第I部：Gemini CLIとModel Context Protocol (MCP)入門

### 1.1. Gemini CLI：ターミナルで動作するローカルAIエージェント
Gemini CLIは、Googleが開発したオープンソースのAIエージェントであり、ターミナル内で直接Geminiモデルの能力を利用することを可能にします[1]。多くのAIツールがウェブベースであるのに対し、Gemini CLIは開発者のローカル環境に深く統合されるように設計されています[3]。これにより、コーディング、問題解決、タスク管理といった複雑なワークフローを、使い慣れたコマンドラインインターフェースから自然言語で実行できます[1]。

その最大の特徴の一つは、ローカルで動作するというアーキテクチャです。これにより、ユーザーのコードやデータが外部サーバーに送信されることなく処理されるため、セキュリティとプライバシーが強化されます[3]。さらに、Gemini CLIは単なる対話ツールにとどまらず、外部のツールやサービスと連携する能力を持っています。この拡張性の中心的な役割を担うのが、Model Context Protocol (MCP) です[2]。

### 1.2. Gemini CLIにおけるMCPの役割：能力の拡張
Model Context Protocol (MCP) は、AIアプリケーションが外部のツール、システム、データソースと統合する方法を標準化するために設計されたオープンプロトコルです[6]。Gemini CLIにとって、MCPは単なる追加機能ではなく、その能力を飛躍的に拡張するための基盤技術です[2]。

MCPを利用することで、Gemini CLIは以下のようなことが可能になります：
- **カスタムツールの統合:** 開発者は独自のツールを作成し、MCPサーバーとして公開することで、Gemini CLIの標準機能にはない特定のタスク（例：社内データベースへのクエリ、特定のAPIの呼び出し）を実行させることができます[1]。
- **動的なツール発見:** Gemini CLIは、設定されたMCPサーバーが提供するツールを動的に発見し、ユーザーのプロンプトに応じて最適なツールを自律的に選択・実行します[9]。
- **エコシステムの活用:** GitHub、Slack、Postgresなど、コミュニティによって開発された既存のMCPサーバーに接続することで、多種多様なサービスとの連携を迅速に実現できます[6]。

HTTPがウェブの通信を標準化したように、MCPはAIエージェントと外部ツール間の「対話」を標準化するプロトコルと考えることができます[11]。

### 1.3. Gemini CLIのツール拡張アーキテクチャ
Gemini CLIは、主に2つの方法でカスタムツールやコマンドを統合します[1]。

- **MCPサーバー (MCP Servers):** より複雑で動的なツールを提供するための主要な方法です。開発者はPythonやGoなどの言語で軽量なサーバープログラムを作成し、特定の機能（データアクセス、API連携など）をMCPプロトコルを介して公開します[5]。Gemini CLIは、設定ファイルを通じてこれらのサーバーに接続し、ツールを利用します[1]。
- **.tomlスラッシュコマンド (Slash Commands):** 再利用可能なプロンプトを定義するための、よりシンプルで手軽な方法です[12]。開発者は、特定のディレクトリに`.toml`形式の設定ファイルを作成することで、独自の「スラッシュコマンド」（例：`/plan`）を定義できます。これは、特定の役割や応答形式をGeminiに指示する定型的なタスクを効率化するのに役立ちます[1]。

この2つのアプローチにより、開発者はタスクの複雑さに応じて最適な拡張方法を選択できます。

### 1.4. コア・プリミティブ：MCPの言語（ツールとプロンプト）
MCPは、サーバーが公開できる3つの中心的な「プリミティブ」を定義していますが、Gemini CLIの文脈では特に以下の2つが重要です[9]。

- **ツール (Tools):** LLM（この場合はGemini）が自律的に呼び出すことを決定できる実行可能な関数です。例えば、データベースから情報を取得する関数や、外部APIを呼び出す関数などがこれにあたります[9]。これはMCPサーバーを介して提供されます。
- **プロンプト (Prompts):** LLMとの対話をガイドするための、事前定義されたテンプレートや指示です[9]。Gemini CLIでは、このプリミティブが`.toml`ファイルによるスラッシュコマンドとして実装されており、ユーザーが特定のワークフローを簡単に呼び出すことを可能にしています。

---

## 第II部：Gemini CLIのカスタムツール開発：実践ガイド
このパートでは、開発者がGemini CLIの能力を拡張するための具体的な方法を、2つのアプローチ（`.toml`スラッシュコマンドとPythonによるMCPサーバー開発）に沿って解説します。

### 2.1. 方法1：.tomlによるスラッシュコマンドの作成
ここでは、タスクの計画を支援する`/plan`というスラッシュコマンドを作成します。

**ステップ・バイ・ステップ解説**
1.  **コマンドディレクトリの作成:** グローバルなコマンドを作成するため、ホームディレクトリに設定用のディレクトリを作成します[12]。
    ```bash
    mkdir -p ~/.gemini/commands/
    ```
    > プロジェクト固有のコマンドにしたい場合は、プロジェクトルートに`.gemini/commands/`ディレクトリを作成します[12]。

2.  **.tomlファイルの作成:** 作成したディレクトリ内に、コマンド名に対応するファイルを作成します。ここでは`plan.toml`とします[12]。
    ```bash
    touch ~/.gemini/commands/plan.toml
    ```

3.  **コマンド定義の記述:** `plan.toml`ファイルを開き、コマンドの定義を記述します。必須キーは`description`（コマンドの説明）と`prompt`（モデルへの指示）です。`{{args}}`は、ユーザーがコマンドの後に入力した引数に置き換えられます[12]。
    ```toml
    # ~/.gemini/commands/plan.toml
    description="タスクを達成するための戦略的な計画を調査し、作成します。"
    prompt = """
    あなたの主な役割は実装者ではなく、戦略家です。
    あなたのタスクは、立ち止まって深く考え、以下の目標を達成するための包括的な戦略計画を考案することです: {{args}}

    あなたはコードを記述、変更、実行してはなりません (MUST NOT)。あなたの唯一の機能は、現状を調査し、計画を策定することです。
    利用可能な「read」および「search」ツールを使用して、コードベースを調査・分析してください。戦略を提示する前に、必要なすべてのコンテキストを収集してください。

    戦略計画をマークダウンで提示してください。それはあなたの調査と思考プロセスの直接の結果であるべきです。
    応答を以下のセクションで構成してください:
    1. **目標の理解:** あなたの理解を確認するために、目的を再記述してください。
    2. **調査と分析:** どのような調査手順を踏むかを説明してください。どのファイルを読み込む必要がありますか？何を検索しますか？作業を始める前に、どのような重要な質問に答える必要がありますか？
    3. **提案される戦略的アプローチ:** 高レベルの戦略の概要を説明してください。アプローチを論理的なフェーズに分割し、各フェーズで行われるべき作業を説明してください。
    4. **検証戦略:** この計画の成功がどのように測定されるかを説明してください。目標が達成され、リグレッションが発生していないことを確認するために、何をテストすべきですか？
    5. **予想される課題と考慮事項:** あなたの分析に基づき、どのような潜在的なリスク、依存関係、またはトレードオフを予測しますか？

    あなたの最終的な出力は、この戦略計画のみでなければなりません。
    """
    ```
これで、Gemini CLIを起動すると`/plan`コマンドが利用可能になります。

### 2.2. 方法2：PythonによるMCPサーバー開発
より高度な機能を提供するために、PythonでMCPサーバーを構築します。ここでは、簡単な計算機能を提供するサーバーを作成します。

**ステップ・バイ・ステップ解説**
1.  **環境構築:** 独立したPython環境を用意し、必要なライブラリをインストールします[14]。
    ```bash
    python -m venv mcp-env
    source mcp-env/bin/activate
    pip install "mcp[cli]"
    ```

2.  **サーバーコードの記述:** `calculator_server.py`というファイルを作成し、以下のコードを記述します。`@server.tool`デコレータが、Python関数をLLMが利用可能なツールとして公開する役割を担います[16]。
    ```python
    # calculator_server.py
    from mcp.server.fastmcp import FastMCP

    # 分かりやすい名前を付けてMCPサーバーをインスタンス化
    server = FastMCP("Simple Calculator Server")

    # @server.toolデコレータでツールを定義
    # 関数名、docstring、型ヒントがLLM向けのツールスキーマになる
    @server.tool(name="evaluate_expression", description="簡単な数式文字列を評価し、結果を返します。")
    def evaluate_expression(expression: str) -> float:
        """
        数式を評価します。
        警告: 信頼できない入力に対してeval()を使用するのは安全ではありません。
        本番環境では、安全な数式パーサーライブラリを使用してください。
        """
        try:
            # 安全なevalのための限定的な環境
            result = eval(expression, {"__builtins__": {}}, {})
            return float(result)
        except Exception as e:
            raise ValueError(f"無効な式です: {e}")

    # スクリプトとして直接実行された場合にサーバーを起動
    if __name__ == "__main__":
        print("Calculator MCP Server running over stdio...")
        server.run()
    ```
    このサーバーは、`stdio`（標準入出力）を介して通信します。これは、Gemini CLIのようなローカルクライアントとの連携に適した方法です[9]。

---

## 第III部：開発したツールのGemini CLIへの統合と利用
作成したカスタムコマンドやMCPサーバーをGemini CLIに認識させ、実際に利用する方法を解説します。

### 3.1. .tomlスラッシュコマンドの利用
`.toml`ファイルで定義したスラッシュコマンドは、Gemini CLIを起動するだけで自動的に利用可能になります[12]。対話モードで、`/`を入力すると利用可能なコマンドのリストが表示されます。

先ほど作成した`/plan`コマンドは以下のように使用します。
```
/plan "ユーザー認証機能にOAuth2を追加する"
```
これにより、`.toml`ファイルで定義したプロンプトが、引数と共にGeminiモデルに送信されます。

### 3.2. MCPサーバーの統合
Pythonで作成したMCPサーバーは、`settings.json`ファイルを通じてGemini CLIに登録する必要があります[1]。

- **設定ファイルの場所:** 設定は階層的に適用されます。プロジェクト固有の設定はプロジェクトルートの`.gemini/settings.json`に、ユーザー全体のグローバルな設定は`~/.gemini/settings.json`に記述します[1]。
- **settings.jsonの編集:** `mcpServers`キーに、接続したいサーバーの定義を追加します。各設定項目の意味は以下の通りです[1]。
    - `command`: サーバーを起動するコマンド（例：Python実行ファイルのパス）。
    - `args`: コマンドに渡す引数（例：サーバーのスクリプトファイルへのパス）。
    - `cwd`: コマンドの実行ディレクトリ。
    - `env`: サーバープロセスに渡す環境変数。
    - `trust`: `false`に設定すると、ツール実行前にユーザーの確認を求めます。セキュリティ上、`false`が推奨されます。
    - `includeTools` / `excludeTools`: サーバーが提供するツールのうち、利用を許可または禁止するものを指定します。

以下は、先ほど作成した`calculator_server.py`を登録する設定例です。
```json
{
  "mcpServers": {
    "myCalculatorServer": {
      "command": "/path/to/your/project/mcp-env/bin/python",
      "args": [
        "/path/to/your/project/calculator_server.py"
      ],
      "cwd": "/path/to/your/project",
      "description": "A simple calculator server.",
      "trust": false,
      "includeTools": [
        "evaluate_expression"
      ]
    }
  }
}
```

### 3.3. 統合後の動作確認
設定が完了したら、Gemini CLIを再起動し、ツールが正しく認識されているか確認します。

1.  **サーバー接続の確認:** `/mcp`コマンドを実行すると、接続されているMCPサーバーのリストとステータスが表示されます[2]。
2.  **利用可能なツールの確認:** `/tools`コマンドで、現在利用可能なすべてのツール（組み込みツールとMCPサーバーから提供されたツール）の一覧を確認できます[2]。`/mcp desc`コマンドを使えば、より詳細な説明を見ることができます[5]。

確認後、自然言語で計算を依頼するプロンプトを入力します。
> 15 * (10 + 5) の結果は？

Gemini CLIは、このタスクを解決するために`evaluate_expression`ツールが最適だと判断し、実行許可を求めてきます。承認すると、ローカルでMCPサーバーが実行され、その結果がGeminiの最終的な応答に利用されます。

---

## 第IV部：Gemini CLIとMCP連携におけるセキュリティ考察
Gemini CLIに外部ツールを連携させる機能は強力ですが、同時にセキュリティ上のリスクも伴います。安全な運用のためには、これらのリスクを理解し、適切な対策を講じることが不可欠です。

### 4.1. MCPの基本セキュリティ原則
MCPの公式仕様は、ユーザーが制御権を保持するという原則に基づいています[17]。
- **ユーザーの同意と制御:** ユーザーは、すべてのデータアクセスと操作に対して明示的に同意しなければなりません。Gemini CLIでは、`trust: false`設定がこの原則の実装に役立ちます[17]。
- **データプライバシー:** ユーザーの同意なしにユーザーデータが送信されてはなりません[17]。
- **ツールの安全性:** ツールは任意のコードを実行する可能性があるため、信頼できるソースからのツールのみを使用することが重要です[18]。

### 4.2. 脅威のランドスケープ：主要な脆弱性と攻撃ベクトル
Gemini CLIとMCPサーバーの連携においては、以下のようなリスクが考えられます。
- **信頼できないMCPサーバー:** 悪意のある、または脆弱なMCPサーバーに接続すると、コマンドインジェクションやデータ漏洩のリスクが生じます[18]。特に、ローカルで任意のコマンドを実行できるサーバーは危険です。
- **設定の不備:** `settings.json`の設定ミスは、意図しないツールの実行や、セキュリティリスクの増大につながる可能性があります。特に、`trust: true`の設定は慎重に行うべきです[1]。
- **混乱した代理人問題 (Confused Deputy Problem):** MCPサーバーが持つ権限を、権限の低いユーザーが悪用する可能性があります。サーバーは、ユーザーの権限の範囲内でのみ動作するように設計されるべきです[18]。
- **プロンプトインジェクション:** 悪意のあるプロンプトによって、LLMが騙されて意図しないツールを実行させられる可能性があります。例えば、ツールの説明文に悪意のある指示を埋め込む「ツール汚染」などが考えられます[20]。

### 4.3. Gemini CLI実装の強化：ベストプラクティス・チェックリスト
開発者や運用者が参照できる、具体的で実行可能な対策をチェックリストにまとめます。

| カテゴリ | ベストプラクティス | 軽減されるリスク | 実装ノート／出典 |
| :--- | :--- | :--- | :--- |
| **サーバー接続設定** | `settings.json`で`trust: false`をデフォルトにする。 | 意図しないツールの自動実行。 | ユーザーにツール実行の最終的な制御権を与えるための最も重要な設定です[1]。 |
| | `includeTools`と`excludeTools`を使用して、必要なツールのみを明示的に許可する。 | 意図しない、または危険なツールの利用。 | 最小権限の原則を適用し、攻撃対象領域を減らします[1]。 |
| **サーバーの信頼性** | 信頼できる提供元からのMCPサーバーのみを使用する。コミュニティ提供のサーバーはコードをレビューする。 | 悪意のあるサーバー、サプライチェーン攻撃。 | サーバーのコードはローカルで実行されるため、その信頼性は極めて重要です[18]。 |
| | リモートMCPサーバーに接続する場合、強力な認証（mTLS, OAuth 2.0など）を実装する。 | なりすまし、不正アクセス。 | 公開エンドポイントとしてデプロイする場合は、認証が不可欠です[20]。 |
| **サーバー実装** | サーバー側で全ての入力を厳密に検証・サニタイズ（無害化）する。 | コマンドインジェクション、意図しない動作。 | シェルコマンドの実行やデータベースクエリの構築など、危険な操作の前には必ず入力を検証します[20]。 |
| | サーバーは最小権限で動作させる。 | 権限昇格、混乱した代理人問題。 | サーバープロセスが必要とする以上の権限（ファイルアクセス権など）を持たせないようにします[18]。 |
| **運用** | Gemini CLIをサンドボックスモード（`--sandbox`）で実行する。 | 悪意のあるツールによるシステムへの影響。 | DockerやPodmanコンテナ内でツールを実行し、ホストシステムから隔離します[1]。 |

> **ゼロトラストの原則**
> Gemini CLIのセキュリティは、CLI自体の設定と、接続するMCPサーバーの実装の両方に依存します。「ゼロトラスト」の考え方を適用し、接続するサーバーを信頼せず、常に検証することが、安全なエコシステムを維持する鍵となります。

---

## 第V部：パフォーマンス、ベストプラクティス、および戦略的展望
この最終パートでは、実装の詳細から一歩引いて、Gemini CLIのツール連携を効果的に活用するための戦略的な考察を提供します。
